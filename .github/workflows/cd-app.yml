name: CD - Deploy Backend Services

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/services/**'

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP_STAGING: edumind-staging
  AZURE_RESOURCE_GROUP_PRODUCTION: edumind-production

jobs:
  detect-changed-services:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          list-files: 'json'
          filters: |
            user-service:
              - 'backend/services/user-service/**'
            course-service:
              - 'backend/services/course-service/**'
            assessment-service:
              - 'backend/services/assessment-service/**'
            service-xai-prediction:
              - 'backend/services/service-xai-prediction/**'
            service-learning-style:
              - 'backend/services/service-learning-style/**'
            service-engagement-tracker:
              - 'backend/services/service-engagement-tracker/**'

  build-and-push:
    needs: detect-changed-services
    if: needs.detect-changed-services.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changed-services.outputs.services) }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=main-
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend/services/${{ matrix.service }}
          file: backend/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy-to-staging:
    needs: [detect-changed-services, build-and-push]
    if: needs.detect-changed-services.outputs.services != '[]'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Container Apps Staging
        run: |
          echo "Deploying to Azure Container Apps staging environment..."
          
          for service in ${{ join(fromJSON(needs.detect-changed-services.outputs.services), ' ') }}; do
            echo "Deploying $service to staging..."
            
            # Check if Container App exists
            if az containerapp show --name edumind-$service-staging --resource-group ${{ env.AZURE_RESOURCE_GROUP_STAGING }} >/dev/null 2>&1; then
              echo "Updating existing Container App: edumind-$service-staging"
              az containerapp update \
                --name edumind-$service-staging \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP_STAGING }} \
                --image ${{ env.REGISTRY }}/${{ github.repository }}/$service:${{ github.sha }}
            else
              echo "Container App edumind-$service-staging does not exist. Please create it first."
              exit 1
            fi
          done
      
      - name: Verify staging deployment
        run: |
          echo "Verifying staging deployment health..."
          sleep 30
          
          for service in ${{ join(fromJSON(needs.detect-changed-services.outputs.services), ' ') }}; do
            echo "Checking health of $service..."
            # Add health check commands here
            # Example: curl -f https://edumind-$service-staging.azurecontainerapps.io/health
          done

  deploy-to-production:
    needs: [detect-changed-services, deploy-to-staging]
    if: needs.deploy-to-staging.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy to Azure Container Apps Production
        run: |
          echo "Deploying to Azure Container Apps production environment..."
          
          for service in ${{ join(fromJSON(needs.detect-changed-services.outputs.services), ' ') }}; do
            echo "Deploying $service to production..."
            
            # Check if Container App exists
            if az containerapp show --name edumind-$service --resource-group ${{ env.AZURE_RESOURCE_GROUP_PRODUCTION }} >/dev/null 2>&1; then
              echo "Updating existing Container App: edumind-$service"
              az containerapp update \
                --name edumind-$service \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP_PRODUCTION }} \
                --image ${{ env.REGISTRY }}/${{ github.repository }}/$service:${{ github.sha }}
            else
              echo "Container App edumind-$service does not exist. Please create it first."
              exit 1
            fi
          done
      
      - name: Run production health checks
        run: |
          echo "Running production health checks..."
          sleep 30
          
          for service in ${{ join(fromJSON(needs.detect-changed-services.outputs.services), ' ') }}; do
            echo "Checking production health of $service..."
            # Add production health check commands
            # Example: curl -f https://edumind-$service.azurecontainerapps.io/health
          done
      
      - name: Notify deployment success
        if: success()
        run: |
          echo "Successfully deployed services to production!"
          echo "Services deployed: ${{ join(fromJSON(needs.detect-changed-services.outputs.services), ', ') }}"